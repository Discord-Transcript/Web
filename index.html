<!--
  Small microservice to generate a Discord-like chat section
  Copyright (C) 2019-present Bowser65

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport'
        content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0'>
  <meta http-equiv='X-UA-Compatible' content='ie=edge'>
  <title>Discord Chat Archive</title>
  <link rel='stylesheet' href='https://highlightjs.org/static/demo/styles/solarized-dark.css'>
  <style>
    * {
      box-sizing: border-box;
    }

    @font-face {
      font-family: Whitney;
      font-weight: 400;
      src: url(https://discordapp.com/assets/e8acd7d9bf6207f99350ca9f9e23b168.woff) format("woff")
    }

    @font-face {
      font-family: Whitney;
      font-weight: 500;
      src: url(https://discordapp.com/assets/3bdef1251a424500c1b3a78dea9b7e57.woff) format("woff")
    }

    @font-face {
      font-family: Whitney;
      font-weight: 600;
      src: url(https://discordapp.com/assets/be0060dafb7a0e31d2a1ca17c0708636.woff) format("woff")
    }

    .theme-dark {
      --background: #36393f;
      --background-dark: #2f3136;
      --background-very-dark: #202225;
      --color: #fff;
      --color-gray: #72767d;
      --elevation: 0 1px 0 rgba(4, 4, 5, 0.2), 0 1.5px 0 rgba(6, 6, 7, 0.05), 0 2px 0 rgba(4, 4, 5, 0.05);
      --spacer: hsla(0, 0%, 100%, 0.06);
      --theme: url(https://discordapp.com/assets/522c8314225487737f7dd4ead8d4a731.svg);
    }

    .theme-light {
      --background: #fff;
      --background-dark: #f2f3f5;
      --background-very-dark: #e3e5e8;
      --color: #2e3338;
      --color-gray: #747f8d;
      --elevation: 0 1px 0 rgba(6, 6, 7, 0.1), 0 1.5px 0 rgba(6, 6, 7, 0.025), 0 2px 0 rgba(6, 6, 7, 0.025);
      --spacer: rgba(6, 6, 7, 0.08);
      --theme: url(https://discordapp.com/assets/6c8c8654d649bee316b88e2342b6c8fa.svg);
    }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      color: var(--color);
      background-color: var(--background);
      font-family: Whitney, sans-serif;
      overflow: hidden;
    }

    a {
      color: #00b0f4;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .header-bar {
      display: flex;
      align-items: center;
      user-select: none;
      height: 48px;
      font-weight: 600;
      font-size: 16px;
      box-shadow: var(--elevation);
    }

    .header-bar svg {
      margin-left: 16px;
      margin-right: 8px;
      margin-top: 1px;
      color: var(--color-gray)
    }

    .header-bar #theme-toggle {
      margin-left: auto;
      width: 24px;
      height: 24px;
      background-image: var(--theme);
      margin-right: 16px;
      cursor: pointer;
    }

    .messages {
      overflow-y: auto;
      height: calc(100% - 48px);
    }

    .message {
      display: flex;
      padding: 20px 0;
      margin: 0 20px;
      border-bottom: 1px var(--spacer) solid;
    }

    .message .avatar {
      width: 40px;
      height: 43px;
      border-radius: 50%;
      margin-right: 20px;
      padding-top: 3px;
      user-select: none;
    }

    .message .header {
      display: flex;
      align-items: center;
      user-select: none;
    }

    .message .header .name {
      font-weight: 500;
      font-size: 1rem;
      line-height: 1.375em;
      cursor: pointer;
    }

    .message .header .name:hover {
      text-decoration: underline;
    }

    .message .header .badge {
      background: #7289da;
      color: #fff;
      font-size: .625em;
      font-weight: 500;
      padding: .072rem .275rem;
      border-radius: 3px;
      text-transform: uppercase;
      line-height: 1.3;
      margin: 1px 5px 0;
    }

    .message .header .time {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-gray);
      margin-left: .3rem;
      margin-top: 2px;
    }

    .message .details {
      flex: 1;
    }

    .message .msg {
      white-space: pre-wrap;
    }

    .message .msg p {
      margin: 0;
    }

    .message .msg code, .message .msg pre {
      width: auto;
      height: auto;
      padding: .2em;
      margin: -.2em 0;
      border-radius: 3px;
      font-size: 85%;
      font-family: Consolas, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Monaco, Courier New, Courier, monospace;
      text-indent: 0;
      border: none;
      white-space: pre-wrap;
      background: var(--background-dark);
    }

    .message .msg pre {
      border: 1px solid var(--background-very-dark);
      max-width: 90%;
      border-radius: 4px;
      margin-top: 6px;
      white-space: pre-wrap;
      background-clip: border-box;
      padding: .5em;
      position: relative;
      font-size: 100%;
    }

    .message .msg pre code {
      font-size: 100%;
    }

    .message .msg blockquote {
      display: flex;
      margin: 0;
    }

    .message .msg blockquote .side {
      margin: 8px 0;
      width: 4px;
      border-radius: 4px;
      background-color: #4f545c;
    }

    .message .msg blockquote .content {
      padding: 0 8px 0 12px;
      margin: 8px 0;
    }

    .message .msg img {
      margin-top: 8px;
      max-width: 520px;
    }

    .attachment {
      display: flex;
      border: 1px rgba(47, 49, 54, .6) solid;
      background-color: rgba(47, 49, 54, .3);
      align-items: center;
      max-width: 520px;
      width: 100%;
      padding: 10px;
      border-radius: 3px;
    }

    .msg .attachment .icon {
      width: 30px;
      height: 40px;
      margin-right: 8px;
      margin-top: 0;
      flex-shrink: 0;
    }

    .attachment .details {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .attachment .details a {
      opacity: .85;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .attachment .details span {
      font-weight: 300;
      color: #72767d;
      margin-right: 8px;
      line-height: 16px;
      font-size: 12px;
    }

    .attachment .download {
      color: #4f545c;
      width: 24px;
      height: 24px;
    }

    .img-enlarged {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 666;
      background-color: rgba(0, 0, 0, .8);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .img-enlarged .inner {
      display: flex;
      flex-direction: column;
    }

    .img-enlarged .inner img {
      max-height: 680px;
    }

    .img-enlarged a {
      font-size: 14px;
      font-weight: 500;
      display: block;
      align-self: flex-start;
      color: #fff !important;
      text-decoration: none;
      line-height: 30px;
      opacity: .5;
      flex-grow: 0;
    }

    .img-enlarged.opened {
      display: flex;
      animation: img1 .4s;
    }

    .img-enlarged.opened .inner {
      transform-origin: 50% 50%;
      animation: img2 .4s;
    }

    .img-enlarged.closing {
      display: flex;
      animation: img3 .2s;
    }

    .img-enlarged.closing .inner {
      animation: img4 .2s;
    }

    .img-enlarged.closing {
      opacity: 1;
    }

    img[data-enlargable] {
      cursor: pointer;
    }

    @keyframes img1 {
      from {
        opacity: .4;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes img2 {
      from {
        opacity: 0;
        transform: scale(.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes img3 {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    @keyframes img4 {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(.5);
      }
    }
  </style>
</head>
<body class='theme-dark'>
  {react}
  <div id='enlarge' class='img-enlarged'>
    <div class='inner'>
      <img src='' alt=''/>
      <a href='' target='_blank'>Open Original</a>
    </div>
  </div>
  <textarea id='clipboard' style='display: none'></textarea>
  <script>
    // Light theme toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.className = document.body.className.includes('dark') ? 'theme-light' : 'theme-dark'
    })

    // Timestamps
    document.querySelectorAll('[data-timestamp]').forEach(el => {
      const days = [ 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday' ]
      const today = new Date()
      const date = new Date(parseInt(el.dataset.timestamp))
      const daysBetween = (today.getUTCFullYear() - date.getUTCFullYear()) * 365
        + (today.getUTCMonth() - date.getUTCMonth()) * 30
        + (today.getUTCDate() - date.getUTCDate())
      if (daysBetween === 0) {
        el.innerText = `Today at ${date.getUTCHours()}:${date.getUTCMinutes()}`
      } else if (daysBetween === 1) {
        el.innerText = `Yesterday at ${date.getUTCHours()}:${date.getUTCMinutes()}`
      } else if (daysBetween < 7) {
        el.innerText = `Last ${days[date.getUTCDay() - 1]} at ${date.getUTCHours()}:${date.getUTCMinutes()}`
      } else {
        el.innerText = `${date.getUTCDay()}/${date.getUTCMonth()}/${date.getUTCFullYear()}`
      }
    })

    // Copy ID
    const textarea = document.getElementById('clipboard')
    document.querySelectorAll('[data-copy-id]').forEach(el => {
      el.addEventListener('click', () => {
        textarea.style.display = 'block'
        textarea.value = el.dataset.copyId
        textarea.select()
        document.execCommand('copy')
        textarea.style.display = 'none'
      })
    })

    // Enlarge
    const enlarge = document.getElementById('enlarge')
    enlarge.addEventListener('click', () => {
      enlarge.classList.remove('opened')
      enlarge.classList.add('closing')
      setTimeout(() => enlarge.classList.remove('closing'), 200)
    })
    enlarge.querySelector('img').addEventListener('click', e => e.stopPropagation())
    document.querySelectorAll('[data-enlargable]').forEach(el => {
      el.addEventListener('click', () => {
        enlarge.querySelector('img').src = el.src
        enlarge.querySelector('a').href = el.src
        enlarge.classList.add('opened')
      })
    })
  </script>
  <script src="https://cdn.jsdelivr.net/npm/highlightjs-line-numbers.js@2.6.0/dist/highlightjs-line-numbers.min.js"></script>
</body>
</html>
